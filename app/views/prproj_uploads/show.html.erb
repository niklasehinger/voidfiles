<% require 'cgi' %>
<div class="min-h-screen flex flex-col bg-gradient-to-br from-voidfiles-white to-gray-50">
  <!-- Header -->
  <header class="w-full bg-white/80 backdrop-blur border-b border-gray-100 sticky top-0 z-30">
    <div class="max-w-7xl mx-auto flex items-center justify-between px-6 py-4">
      <div class="flex items-center gap-2">
        <span class="inline-block w-8 h-8 rounded-lg bg-voidfiles-blue flex items-center justify-center text-white font-bold text-2xl">V</span>
        <span class="font-bold text-lg text-voidfiles-navy tracking-tight">VoidFiles</span>
      </div>
      <nav class="hidden md:flex gap-8 text-base font-medium">
        <a href="/" class="text-voidfiles-navy hover:text-voidfiles-blue transition">Startseite</a>
        <a href="#features" class="text-voidfiles-navy hover:text-voidfiles-blue transition">Features</a>
        <a href="#pricing" class="text-voidfiles-navy hover:text-voidfiles-blue transition">Preise</a>
        <a href="/faq" class="text-voidfiles-navy hover:text-voidfiles-blue transition">FAQ</a>
      </nav>
    </div>
  </header>

  <div class="flex-1 py-16">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      <h1 class="text-3xl font-extrabold text-voidfiles-navy mb-8 text-center">Referenzierte Medien im Projekt</h1>
      <p class="text-center text-gray-700 mb-6">Deine Medien wurden erfolgreich erkannt. Du kannst jetzt selbst testen, ob alles korrekt ist – oder die KI genutzte und ungenutzte Medien sortieren lassen.</p>
      <div class="bg-white rounded-xl shadow p-8 border border-gray-100">
        <div class="mb-4 text-sm text-gray-500 text-center">Sollten keine Medien angezeigt werden, lade die Seite bitte einmal neu. Die Analyse kann wenige Sekunden dauern.</div>
        <% tree = @prproj_upload.media_tree %>
        <% if tree.present? %>
          <style>
            .finder-breadcrumb {
              display: flex;
              align-items: center;
              gap: 0.5em;
              margin-bottom: 1.5em;
              flex-wrap: wrap;
            }
            .finder-breadcrumb a {
              color: #2563eb;
              text-decoration: none;
              font-weight: 500;
              transition: color 0.2s;
            }
            .finder-breadcrumb a:hover {
              color: #1e40af;
              text-decoration: underline;
            }
            .finder-list {
              display: flex;
              flex-wrap: wrap;
              gap: 2em 2.5em;
              min-height: 120px;
              justify-content: flex-start;
            }
            .finder-item {
              display: flex;
              flex-direction: column;
              align-items: center;
              cursor: pointer;
              min-width: 110px;
              max-width: 180px;
              padding: 0.7em 0.3em 0.5em 0.3em;
              border-radius: 0.75em;
              transition: background 0.15s, box-shadow 0.15s;
              box-shadow: 0 2px 8px 0 rgba(36, 61, 120, 0.04);
              background: #f8fafc;
            }
            .finder-item:hover {
              background: #e0e7ef;
              box-shadow: 0 4px 16px 0 rgba(36, 61, 120, 0.10);
            }
            .finder-icon {
              width: 48px;
              height: 48px;
              margin-bottom: 0.4em;
              display: block;
            }
            .finder-label {
              font-size: 1.08em;
              font-weight: 500;
              color: #1e293b;
              text-align: center;
              word-break: break-all;
              margin-top: 0.1em;
            }
          </style>
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              var tree = <%= raw(tree.to_json) %>;
              var path = [];
              var container = document.getElementById('finder-container');
              var breadcrumb = document.getElementById('finder-breadcrumb');
              var list = document.getElementById('finder-list');

              function getCurrentNode() {
                return path.reduce(function(node, part) {
                  return node && node[part] ? node[part] : {};
                }, tree);
              }

              function renderBreadcrumb() {
                breadcrumb.innerHTML = '';
                var fullPath = [];
                var home = document.createElement('a');
                home.textContent = 'Root';
                home.href = '#';
                home.onclick = function(e) { e.preventDefault(); path = []; render(); };
                breadcrumb.appendChild(home);
                path.forEach(function(part, idx) {
                  breadcrumb.appendChild(document.createTextNode(' / '));
                  fullPath.push(part);
                  var link = document.createElement('a');
                  link.textContent = decodeURIComponent(part);
                  link.href = '#';
                  link.onclick = function(e) { e.preventDefault(); path = path.slice(0, idx + 1); render(); };
                  breadcrumb.appendChild(link);
                });
              }

              function renderList() {
                list.innerHTML = '';
                var node = getCurrentNode();
                var folders = [];
                var files = [];
                Object.keys(node).forEach(function(key) {
                  if (Object.keys(node[key]).length > 0) {
                    folders.push(key);
                  } else {
                    files.push(key);
                  }
                });
                folders.sort();
                files.sort();
                folders.forEach(function(folder) {
                  var div = document.createElement('div');
                  div.className = 'finder-item';
                  div.innerHTML = `
                    <svg class="finder-icon" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <rect x="4" y="14" width="40" height="26" rx="4" fill="#2563eb"/>
                      <path d="M4 18V14a4 4 0 0 1 4-4h10a4 4 0 0 1 3.2 1.6l2.4 3.2A4 4 0 0 0 27.8 16H44a0 0 0 0 1 0 0v2" fill="#3b82f6"/>
                    </svg>
                    <span class="finder-label">${decodeURIComponent(folder)}</span>
                  `;
                  div.onclick = function() { path.push(folder); render(); };
                  list.appendChild(div);
                });
                files.forEach(function(file) {
                  var div = document.createElement('div');
                  div.className = 'finder-item';
                  div.innerHTML = `
                    <svg class="finder-icon" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <rect x="8" y="8" width="32" height="36" rx="4" fill="#cbd5e1"/>
                      <rect x="8" y="8" width="32" height="8" rx="2" fill="#94a3b8"/>
                    </svg>
                    <span class="finder-label">${decodeURIComponent(file)}</span>
                  `;
                  list.appendChild(div);
                });
              }

              function render() {
                renderBreadcrumb();
                renderList();
              }
              render();
            });
          </script>
          <div id="finder-container">
            <div id="finder-breadcrumb" class="finder-breadcrumb"></div>
            <div id="finder-list" class="finder-list"></div>
          </div>
        <% else %>
          <div class="text-gray-500 text-center py-8">Keine Medien im Projekt gefunden.</div>
        <% end %>
      </div>
      <% if @ki_analysis.present? %>
        <div class="mt-10">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 shadow-sm">
              <h2 class="text-xl font-bold text-voidfiles-blue mb-4 flex items-center gap-2">
                <svg class="inline w-6 h-6 text-voidfiles-blue" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                Genutzte Medien
              </h2>
              <% JSON.parse(@ki_analysis)["used"].each do |path| %>
                <div class="py-1 px-2 rounded text-sm text-voidfiles-navy bg-white/80 mb-1 truncate border border-blue-100">
                  <%= path %>
                </div>
              <% end %>
              <% if JSON.parse(@ki_analysis)["used"].empty? %>
                <div class="text-gray-400 italic">Keine genutzten Medien erkannt.</div>
              <% end %>
            </div>
            <div class="bg-gray-50 border border-gray-200 rounded-xl p-6 shadow-sm">
              <h2 class="text-xl font-bold text-voidfiles-navy mb-4 flex items-center gap-2">
                <svg class="inline w-6 h-6 text-voidfiles-navy" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h8M12 8v8"/></svg>
                Ungenutzte Medien
              </h2>
              <% JSON.parse(@ki_analysis)["unused"].each do |path| %>
                <div class="py-1 px-2 rounded text-sm text-gray-700 bg-white/80 mb-1 truncate border border-gray-100">
                  <%= path %>
                </div>
              <% end %>
              <% if JSON.parse(@ki_analysis)["unused"].empty? %>
                <div class="text-gray-400 italic">Keine ungenutzten Medien erkannt.</div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
      <div class="mt-8 flex flex-col sm:flex-row justify-center gap-4">
        <a href="/" class="btn-secondary px-6 py-3">Zurück zur Startseite</a>
        <%= form_with url: analyze_ki_prproj_upload_path(@prproj_upload), method: :post, local: true, data: { turbo: false } do %>
          <%= submit_tag "KI-Analyse starten", class: "px-6 py-3 rounded-lg font-semibold text-white bg-voidfiles-red hover:bg-red-700 transition shadow focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2" %>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-voidfiles-navy text-voidfiles-white py-12 mt-0">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <div class="text-2xl font-bold mb-4 text-white">VoidFiles</div>
        <p class="text-gray-300 mb-6">
          Intelligente Analyse von Adobe Premiere Pro-Projekten
        </p>
        <div class="text-sm text-gray-400">
          © 2024 VoidFiles. Entwickelt mit Ruby on Rails, Tailwind CSS und GPT-4.
        </div>
      </div>
    </div>
  </footer>
</div> 